# BASE IMAGE.
FROM ubuntu:20.04

# RUN A SYSTEM UPDATE, INSTALL python3, pip3 AND DEPENDENCIES FOR geoviews.
RUN apt-get update && apt-get install -y python3 \ 
    python3-pip libproj-dev proj-data proj-bin libgeos-dev

# INSTALL git INTO THE CONTAINER
RUN apt-get -y install git

# COPY requirements.txt AND INSTALL THE PYTHON LIBRARIES.
COPY requirements.txt requirements.txt
# NOTE. numpy MUST BE INSTALLED FIRST TO PREVENT cartopy FROM ERRORING DURING INSTALL. ALL OTHER LIBRARIES ARE INSTALLED VIA requirements.txt.
RUN pip3 install numpy==1.24.3
RUN pip3 install -r requirements.txt

# EXPOSE CONTAINER PORTS REQUIRED TO LAUNCH THE JUPYTER NOTEBOOK (CONTAINER PORT 8888, MAPPED TO LOCAL PORT 8889 IN docker-compose.yaml).
# ALSO EXPOSE CONTAINER PORTS REQUIRED TO SERVE MULTIPLE panel APPS - NEED TO USE A RANGE OF PORTS SO THAT MULTIPLE (50) panel APPS CAN BE SERVED. PORT RANGE USED 10052-10101. SAME PORTS USED IN CONTAINER AND LOCALLY.
EXPOSE 8888 10052-10101

# CREATE A NEW SYSTEM USER.
RUN useradd -ms /bin/bash dataanalyst

# IN ORDER TO GIVE THE NEW USER OWNERSHIP OVER THE WORKING DIRECTORY, SWITCH TO ROOT USER FOR CHOWN COMMAND.
USER root

# SET THE CONTAINER WORKING DIRECTORY TO THE NEW USER'S HOME FOLDER.
WORKDIR /home/dataanalyst

# CHANGE OWNER OF WORKING DIRECTORY TO THIS NEW USER (EXECUTED AS ROOT).
RUN chown -R dataanalyst:dataanalyst /home/dataanalyst

# SWITCH BACK TO NEW USER.
USER dataanalyst

# START THE JUPYTER NOTEBOOK.
ENTRYPOINT ["jupyter","notebook", "--ip=*"]

